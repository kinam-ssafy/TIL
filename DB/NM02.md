# Django Many To Many Relationships 02
## ì¿¼ë¦¬ ìµœì í™” ë° íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„ (ì™„ì „íŒ)

## ğŸ“š ëª©ì°¨

### 1. íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„
- í”„ë¡œí•„ í˜ì´ì§€
- ëª¨ë¸ ê´€ê³„ ì„¤ì •
- ê¸°ëŠ¥ êµ¬í˜„

### 2. Fixtures
- dumpdata
- loaddata

### 3. Improve query (ì¿¼ë¦¬ ìµœì í™”)
- ì‚¬ì „ ì¤€ë¹„
- annotate
- select_related
- prefetch_related
- select_related & prefetch_related
- 'exists' method
- í•œêº¼ë²ˆì— dump í•˜ê¸°
- loaddata ì¸ì½”ë”© ì—ëŸ¬

---

## ğŸ¯ í•™ìŠµ ëª©í‘œ

- Django ORMì˜ ì¿¼ë¦¬ ìµœì í™” ê¸°ë²•ì„ ì´í•´í•˜ê³  ì ìš©í•  ìˆ˜ ìˆë‹¤
- N+1 Problemì„ ì¸ì‹í•˜ê³  í•´ê²°í•  ìˆ˜ ìˆë‹¤
- select_relatedì™€ prefetch_relatedì˜ ì°¨ì´ë¥¼ ì´í•´í•œë‹¤
- íŒ”ë¡œìš° ê¸°ëŠ¥ì„ í†µí•´ self ì°¸ì¡° ê´€ê³„ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤
- fixturesë¥¼ í™œìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ê³  ë³µì›í•  ìˆ˜ ìˆë‹¤
- annotateì™€ exists ë©”ì„œë“œë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤

---

## 1ï¸âƒ£ íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„

### í”„ë¡œí•„ í˜ì´ì§€

#### ê°œìš”

**í”„ë¡œí•„ í˜ì´ì§€ë€?**
- ê° íšŒì›ì˜ ê°œì¸ í”„ë¡œí•„ í˜ì´ì§€ì— íŒ”ë¡œìš° ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ í”„ë¡œí•„ í˜ì´ì§€ë¥¼ ë¨¼ì € êµ¬í˜„í•˜ê¸°
- í”„ë¡œí•„ í˜ì´ì§€ì— í•´ë‹¹ ì‚¬ìš©ìì˜ ì¶”ê°€ ì •ë³´ë¥¼ ê°™ì´ ë³¼ ìˆ˜ ìˆê²Œ ë‚´ìš© ì¶”ê°€

**í‘œì‹œí•  ì •ë³´:**
- í•´ë‹¹ ì‚¬ìš©ìê°€ ì‘ì„±í•œ ê²Œì‹œê¸€ ëª©ë¡
- í•´ë‹¹ ì‚¬ìš©ìê°€ ì‘ì„±í•œ ëŒ“ê¸€ ëª©ë¡
- í•´ë‹¹ ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²Œì‹œê¸€ ëª©ë¡

---

#### í”„ë¡œí•„ í˜ì´ì§€ êµ¬í˜„ (1/6) - URL

```python
# accounts/urls.py

app_name = 'accounts'
urlpatterns = [
    path('login/', views.login, name='login'),
    path('logout/', views.logout, name='logout'),
    # ... (ì¤‘ëµ)
    path('profile/<username>/', views.profile, name='profile'),
]
```

**í¬ì¸íŠ¸:**
- í”„ë¡œí•„ í˜ì´ì§€ëŠ” ì‚¬ìš©ìì™€ ê´€ë ¨ëœ ê¸°ëŠ¥ì´ê¸° ë•Œë¬¸ì— 'accounts' ì•±ì˜ 'urls.py'ì— ì¶”ê°€
- ë¡œê·¸ì¸í•œ ìœ ì € ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ë¥¸ ì‚¬ëŒì˜ í”„ë¡œí•„ í˜ì´ì§€ ë°©ë¬¸ë„ ê°€ëŠ¥í•´ì•¼ í•¨
- ì‚¬ìš©ìì˜ usernameì„ variable routingì„ í™œìš©í•˜ì—¬ ì •ë³´ ì „ë‹¬ì´ í•„ìš”

---

#### í”„ë¡œí•„ í˜ì´ì§€ êµ¬í˜„ (2/6) - View

```python
# accounts/views.py

from django.contrib.auth import get_user_model

def profile(request, username):
    User = get_user_model()
    person = User.objects.get(username=username)
    context = {
        'person': person,
    }
    return render(request, 'accounts/profile.html', context)
```

**í¬ì¸íŠ¸:**
- URLë¡œ ì „ë‹¬ë˜ëŠ” usernameì„ ì´ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ì´ë¥¼ templateìœ¼ë¡œ ì „ë‹¬
- ìœ ì € ëª¨ë¸ì€ ì§ì ‘ import í•˜ì§€ ì•Šê³  `get_user_model()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨

---

#### í”„ë¡œí•„ í˜ì´ì§€ êµ¬í˜„ (3/6) - Template

```django
<!-- accounts/profile.html -->

<h1>{{ person.username }}ë‹˜ì˜ í”„ë¡œí•„</h1>

<h2>{{ person.username }}ë‹˜ì´ ì‘ì„±í•œ ê²Œì‹œê¸€</h2>
<hr>
{% for article in person.article_set.all %}
  <div>{{ article.title }}</div>
{% endfor %}

<h2>{{ person.username }}ë‹˜ì´ ì‘ì„±í•œ ëŒ“ê¸€</h2>
<hr>
{% for comment in person.comment_set.all %}
  <div>{{ comment.content }}</div>
{% endfor %}

<h2>{{ person.username }}ë‹˜ì´ ì¢‹ì•„ìš”í•œ ê²Œì‹œê¸€</h2>
<hr>
{% for article in person.like_articles.all %}
  <div>{{ article.title }}</div>
{% endfor %}
```

---

#### í”„ë¡œí•„ í˜ì´ì§€ êµ¬í˜„ (4/6) - ë‚´ í”„ë¡œí•„ ë§í¬

```django
<!-- articles/index.html -->

<h1>Articles</h1>

{% if request.user.is_authenticated %}
  <h3>Hello, {{ user.username }}</h3>
  <a href="{% url 'accounts:profile' user.username %}">ë‚´ í”„ë¡œí•„</a>
  <a href="{% url 'articles:create' %}">NEW</a>
  <!-- ... (ì¤‘ëµ) -->
{% endif %}

<hr>
```

---

#### í”„ë¡œí•„ í˜ì´ì§€ êµ¬í˜„ (5/6) - ì‘ì„±ì í”„ë¡œí•„ ë§í¬

```django
<!-- articles/index.html -->

{% for article in articles %}
  <p>ì‘ì„±ì: 
    <a href="{% url 'accounts:profile' article.user.username %}">
      {{ article.user }}
    </a>
  </p>
  <p>ê¸€ ë²ˆí˜¸: {{ article.pk }}</p>
  <!-- ... (ì¤‘ëµ) -->
  <hr>
{% endfor %}
```

---

#### í”„ë¡œí•„ í˜ì´ì§€ êµ¬í˜„ (6/6) - ê²°ê³¼ í™•ì¸

```
http://127.0.0.1:8000/accounts/profile/admin/

adminë‹˜ì˜ í”„ë¡œí•„

adminê°€ ì‘ì„±í•œ ê²Œì‹œê¸€
- First
- Second

adminê°€ ì‘ì„±í•œ ëŒ“ê¸€
- Article Commentary1
- Article Commentary2

adminê°€ ì¢‹ì•„ìš”í•œ ê²Œì‹œê¸€
- First
```

---

### ëª¨ë¸ ê´€ê³„ ì„¤ì •

#### íŒ”ë¡œìš° ê¸°ëŠ¥ì˜ ëª¨ë¸ ê´€ê³„

**ê´€ê³„ êµ¬ì¡°:**
```
User(M) â†” User(N)
```

**íŠ¹ì§•:**
- íŒ”ë¡œìš°ëŠ” ìœ ì €ì™€ ìœ ì €ì™€ì˜ ê´€ê³„ë¥¼ ë‚˜íƒ€ëƒ„
- íšŒì›ì€ ì—¬ëŸ¬ ëª…ì˜ íšŒì›ì„ íŒ”ë¡œìš° í•  ìˆ˜ ìˆê³  í•œ ëª…ë„ í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŒ
- íšŒì›ì€ ì—¬ëŸ¬ ëª…ì˜ íŒ”ë¡œì›Œë¥¼ ê°€ì§ˆ ìˆ˜ ìˆê³  í•œ ëª…ë„ ê°€ì§€ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŒ

---

#### íŒ”ë¡œìš° ëª¨ë¸ ê´€ê³„ ì„¤ì • (1/2)

```python
# accounts/models.py

from django.contrib.auth.models import AbstractUser
from django.db import models

class User(AbstractUser):
    followings = models.ManyToManyField(
        'self', 
        symmetrical=False, 
        related_name='followers'
    )
```

**í¬ì¸íŠ¸:**
- ì»¤ìŠ¤í…€í•œ User ëª¨ë¸ í´ë˜ìŠ¤ì— ManyToManyFieldë¥¼ ì‚¬ìš©í•˜ì—¬ íŒ”ë¡œìš° í•„ë“œë¥¼ ì¶”ê°€
- User ëª¨ë¸ê³¼ ê´€ê³„ë¥¼ ë§ºëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— `settings.AUTH_USER_MODEL`ì„ ì‚¬ìš©í•´ë„ ë˜ì§€ë§Œ ìê¸° ìì‹ ê³¼ì˜ ê´€ê³„ì´ê¸° ë•Œë¬¸ì— **'self'**ë¡œ í‘œí˜„í•  ìˆ˜ ìˆìŒ
- íŒ”ë¡œìš° ê¸°ëŠ¥ì€ ë‹¨ë°©í–¥ì˜ ê´€ê³„ì´ê¸° ë•Œë¬¸ì— ë°˜ë“œì‹œ **symmetrical ì†ì„±ì„ False**ë¡œ ì„¤ì •
- **ì°¸ì¡° í•„ë“œ**ëŠ” `followings` í•„ë“œë¡œ ë‚´ê°€ íŒ”ë¡œìš°í•˜ëŠ” ì‚¬ëŒë“¤ì„ ì˜ë¯¸
- **ì—­ì°¸ì¡° í•„ë“œ**ëŠ” `user_set`ì„ ì‚¬ìš©í•´ë„ ë˜ì§€ë§Œ ëª…í™•í•œ ì„¤ì •ì„ ìœ„í•´ `related_name`ì„ ì´ìš©í•˜ì—¬ **'followers'**ë¡œ ë³€ê²½

> **ì°¸ê³ :** ì°¸ì¡°/ì—­ì°¸ì¡°ëŠ” ì„œë¡œ ë°”ë€Œì–´ë„ ìƒê´€ì—†ìœ¼ë‚˜ ê´€ê³„ ì¡°íšŒ ì‹œ ìƒê°í•˜ê¸° í¸í•œ ë°©í–¥ìœ¼ë¡œ ì •í•˜ì—¬ ì‘ì„±

---

#### íŒ”ë¡œìš° ëª¨ë¸ ê´€ê³„ ì„¤ì • (2/2)

**Migration ì§„í–‰ í›„ ì¤‘ê°œ í…Œì´ë¸” í™•ì¸**

```
accounts_user_followings
```

**í…Œì´ë¸” êµ¬ì¡°:**
| Columns | Type |
|---------|------|
| id | INTEGER |
| from_user_id | bigint |
| to_user_id | bigint |

---

### ê¸°ëŠ¥ êµ¬í˜„

#### íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„ (1/5) - URL

```python
# accounts/urls.py

app_name = 'accounts'
urlpatterns = [
    path('login/', views.login, name='login'),
    # ... (ì¤‘ëµ)
    path('profile/<username>/', views.profile, name='profile'),
    path('<int:user_pk>/follow/', views.follow, name='follow'),
]
```

**í¬ì¸íŠ¸:**
- ì–´ëŠ ì‚¬ìš©ìë¥¼ íŒ”ë¡œìš° í•˜ëŠ”ì§€ ìƒëŒ€ ì‚¬ìš©ìì— ëŒ€í•œ ì •ë³´ë¥¼ variable routingì„ í™œìš©í•˜ì—¬ ì „ë‹¬

---

#### íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„ (2/5) - View (ê¸°ë³¸)

```python
# accounts/views.py

from django.contrib.auth.decorators import login_required
from django.shortcuts import redirect

@login_required
def follow(request, user_pk):
    User = get_user_model()
    person = User.objects.get(pk=user_pk)
    
    # ìê¸° ìì‹ ì€ íŒ”ë¡œìš°í•  ìˆ˜ ì—†ìŒ
    if person != request.user:
        # ì´ë¯¸ íŒ”ë¡œìš°í•œ ê²½ìš° â†’ ì–¸íŒ”ë¡œìš°
        if request.user in person.followers.all():
            person.followers.remove(request.user)
        # íŒ”ë¡œìš°í•˜ì§€ ì•Šì€ ê²½ìš° â†’ íŒ”ë¡œìš°
        else:
            person.followers.add(request.user)
    
    return redirect('accounts:profile', person.username)
```

**ë¡œì§:**
1. ì¤‘ê°œ í…Œì´ë¸”ì— ì´ë¯¸ ë‚´ ì •ë³´ê°€ ìˆìœ¼ë©´ ì œê±° (íŒ”ë¡œìš° í•´ì œ)
2. ì¤‘ê°œ í…Œì´ë¸”ì— ë‚´ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€ (íŒ”ë¡œìš° ì§„í–‰)

---

#### íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„ (3/5) - View (exists í™œìš©)

```python
@login_required
def follow(request, user_pk):
    User = get_user_model()
    person = User.objects.get(pk=user_pk)
    
    if person != request.user:
        # exists() ë©”ì„œë“œ í™œìš©
        if person.followers.filter(pk=request.user.pk).exists():
            person.followers.remove(request.user)
        else:
            person.followers.add(request.user)
    
    return redirect('accounts:profile', person.username)
```

**exists() ë©”ì„œë“œ:**
- QuerySetì— ê²°ê³¼ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ True, ì—†ìœ¼ë©´ False ë°˜í™˜
- ëŒ€ê·œëª¨ QuerySetì—ì„œ íŠ¹ì • ê°œì²´ì˜ ì¡´ì¬ ì—¬ë¶€ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ í™•ì¸
- ì „ì²´ QuerySetì„ í‰ê°€í•˜ì§€ ì•Šê³  ê²°ê³¼ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ë§Œ í™•ì¸

---

#### íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„ (4/5) - Template

```django
<!-- accounts/profile.html -->

<h1>{{ person.username }}ë‹˜ì˜ í”„ë¡œí•„</h1>

<div>
  <div>
    íŒ”ë¡œì‰: {{ person.followings.all|length }} / 
    íŒ”ë¡œì›Œ: {{ person.followers.all|length }}
  </div>
  
  {% if request.user != person %}
    <div>
      <form action="{% url 'accounts:follow' person.pk %}" method="POST">
        {% csrf_token %}
        {% if request.user in person.followers.all %}
          <input type="submit" value="ì–¸íŒ”ë¡œìš°">
        {% else %}
          <input type="submit" value="íŒ”ë¡œìš°">
        {% endif %}
      </form>
    </div>
  {% endif %}
</div>

<!-- ì´í•˜ ê²Œì‹œê¸€, ëŒ“ê¸€ ëª©ë¡ ë“± -->
```

---

#### íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„ (5/5) - ê²°ê³¼ í™•ì¸

**í”„ë¡œí•„ í˜ì´ì§€:**
```
http://127.0.0.1:8000/accounts/profile/user1/

user1ë‹˜ì˜ í”„ë¡œí•„
íŒ”ë¡œì‰: 2 / íŒ”ë¡œì›Œ: 1

[íŒ”ë¡œìš°] (ë²„íŠ¼ í´ë¦­ ì‹œ "ì–¸íŒ”ë¡œìš°"ë¡œ ë³€ê²½)
```

**ì¤‘ê°œ í…Œì´ë¸” í™•ì¸:**
```
accounts_user_followings
```

| id | from_user_id | to_user_id |
|----|--------------|------------|
| 1  | 1            | 2          |
| 2  | 1            | 3          |

---

## 2ï¸âƒ£ Fixtures

### Fixturesë€?

**ì •ì˜:**
- Djangoê°€ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì„ ì•Œê³  ìˆëŠ” ë°ì´í„° ëª¨ìŒ
- ë°ì´í„°ë² ì´ìŠ¤ì˜ **ì§ë ¬í™”ëœ(serialized)** ë°ì´í„°

**ìš©ë„:**
- ì´ˆê¸° ë°ì´í„° ì œê³µ
- í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
- ê°œë°œ í™˜ê²½ê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ ê°„ ë°ì´í„° ì´ë™

**ì§€ì› í˜•ì‹:**
- JSON
- XML
- YAML

---

### dumpdata

#### ì •ì˜

**dumpdata:**
- ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ í‘œì¤€ ì¶œë ¥ìœ¼ë¡œ ì¶œë ¥

**ê¸°ë³¸ ì‚¬ìš©ë²•:**
```bash
$ python manage.py dumpdata [app_name[.ModelName]] [options]
```

---

#### ì‚¬ìš© ì˜ˆì‹œ

**ì „ì²´ ë°ì´í„° ì¶”ì¶œ:**
```bash
$ python manage.py dumpdata > data.json
```

**íŠ¹ì • ì•±ì˜ ë°ì´í„°ë§Œ ì¶”ì¶œ:**
```bash
$ python manage.py dumpdata articles > articles.json
$ python manage.py dumpdata accounts > accounts.json
```

**íŠ¹ì • ëª¨ë¸ì˜ ë°ì´í„°ë§Œ ì¶”ì¶œ:**
```bash
$ python manage.py dumpdata articles.article > articles.json
$ python manage.py dumpdata articles.comment > comments.json
$ python manage.py dumpdata accounts.user > users.json
```

**ë“¤ì—¬ì“°ê¸° ì˜µì…˜:**
```bash
$ python manage.py dumpdata --indent 4 articles.article > articles.json
```

---

#### fixtures íŒŒì¼ ì €ì¥ ìœ„ì¹˜

DjangoëŠ” ë‹¤ìŒ ê²½ë¡œì—ì„œ fixtures íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤:

1. `app/fixtures/`
2. `í”„ë¡œì íŠ¸/fixtures/`

**ê¶Œì¥ êµ¬ì¡°:**
```
myproject/
â”œâ”€â”€ articles/
â”‚   â””â”€â”€ fixtures/
â”‚       â”œâ”€â”€ articles.json
â”‚       â””â”€â”€ comments.json
â”œâ”€â”€ accounts/
â”‚   â””â”€â”€ fixtures/
â”‚       â””â”€â”€ users.json
â””â”€â”€ manage.py
```

---

### loaddata

#### ì •ì˜

**loaddata:**
- fixtures ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°

**ê¸°ë³¸ ì‚¬ìš©ë²•:**
```bash
$ python manage.py loaddata articles.json
```

---

#### ì‚¬ìš© ì˜ˆì‹œ

**ë‹¨ì¼ íŒŒì¼ ë¡œë“œ:**
```bash
$ python manage.py loaddata articles.json
```

**ì—¬ëŸ¬ íŒŒì¼ ë¡œë“œ:**
```bash
$ python manage.py loaddata articles.json comments.json users.json
```

**ê²°ê³¼:**
```
Installed 10 object(s) from 1 fixture(s)
```

---

#### ì£¼ì˜ì‚¬í•­

**loaddata ì‹œ ì£¼ì˜ì :**

1. **fixtures íŒŒì¼ ê²½ë¡œ í™•ì¸**
   - `app/fixtures/` ë””ë ‰í† ë¦¬ì— ìœ„ì¹˜í•´ì•¼ í•¨

2. **ì¸ì½”ë”© ë¬¸ì œ**
   - UTF-8 ì¸ì½”ë”© í•„ìˆ˜

3. **ë°ì´í„° ìˆœì„œ**
   - ForeignKey ê´€ê³„ê°€ ìˆëŠ” ê²½ìš°, ì°¸ì¡°ë˜ëŠ” ëª¨ë¸ì„ ë¨¼ì € ë¡œë“œ

4. **ì¤‘ë³µ ë°ì´í„°**
   - ë™ì¼í•œ pkì˜ ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì—ëŸ¬ ë°œìƒ

---

## 3ï¸âƒ£ Improve query (ì¿¼ë¦¬ ìµœì í™”)

### ì‚¬ì „ ì¤€ë¹„

#### ì‹¤ìŠµ í™˜ê²½ ì„¤ì •

**Django shell_plus í™œìš©:**
```bash
$ python manage.py shell_plus
```

**ë”ë¯¸ ë°ì´í„° ìƒì„±:**
```python
# 10ê°œì˜ ê²Œì‹œê¸€ ìƒì„±
for i in range(1, 11):
    Article.objects.create(
        title=f'TEST {i} TITLE',
        content=f'TEST {i} CONTENT'
    )

# ê° ê²Œì‹œê¸€ë§ˆë‹¤ 10ê°œì˜ ëŒ“ê¸€ ìƒì„±
for article in Article.objects.all():
    for i in range(1, 11):
        Comment.objects.create(
            article=article,
            content=f'Comment {i}'
        )
```

---

### annotate

#### ì •ì˜

**annotate:**
- SQLì˜ GROUP BYë¥¼ ì‚¬ìš©
- ì¿¼ë¦¬ì…‹ì˜ ê° ê°ì²´ì— ê³„ì‚°ëœ í•„ë“œë¥¼ ì¶”ê°€

---

#### ì‚¬ìš© ì˜ˆì‹œ (1/2) - ê¸°ë³¸

```python
from django.db.models import Count

# ê° ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ê°œìˆ˜ë¥¼ í•¨ê»˜ ì¡°íšŒ
articles = Article.objects.annotate(
    comment_count=Count('comment')
).order_by('-pk')

for article in articles:
    print(f'{article.title} - ëŒ“ê¸€ {article.comment_count}ê°œ')
```

**ê²°ê³¼:**
```
TEST 10 TITLE - ëŒ“ê¸€ 10ê°œ
TEST 9 TITLE - ëŒ“ê¸€ 10ê°œ
TEST 8 TITLE - ëŒ“ê¸€ 10ê°œ
...
```

---

#### ì‚¬ìš© ì˜ˆì‹œ (2/2) - ì‹¤ì „

```python
# articles/views.py

from django.db.models import Count

def index_1(request):
    articles = Article.objects.annotate(
        comment_count=Count('comment'),
        like_count=Count('like_users')
    ).order_by('-pk')
    
    context = {
        'articles': articles,
    }
    return render(request, 'articles/index_1.html', context)
```

**í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©:**
```django
{% for article in articles %}
  <p>{{ article.title }}</p>
  <p>ëŒ“ê¸€: {{ article.comment_count }}ê°œ</p>
  <p>ì¢‹ì•„ìš”: {{ article.like_count }}ê°œ</p>
{% endfor %}
```

**ì¥ì :**
- ì¶”ê°€ ì¿¼ë¦¬ ì—†ì´ ì§‘ê³„ ê°’ì„ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
- ì„±ëŠ¥ í–¥ìƒ

---

#### ì§‘ê³„ í•¨ìˆ˜ ì¢…ë¥˜

```python
from django.db.models import Count, Sum, Avg, Max, Min

# ëŒ“ê¸€ ê°œìˆ˜
Article.objects.annotate(comment_count=Count('comment'))

# ì¢‹ì•„ìš” ê°œìˆ˜
Article.objects.annotate(like_count=Count('like_users'))

# ê° ìœ ì €ì˜ ì‘ì„± ê²Œì‹œê¸€ ìˆ˜
User.objects.annotate(article_count=Count('article'))

# ê° ìœ ì €ì˜ íŒ”ë¡œì›Œ ìˆ˜ì™€ íŒ”ë¡œì‰ ìˆ˜
User.objects.annotate(
    followers_count=Count('followers'),
    followings_count=Count('followings')
)

# í‰ê· , ìµœëŒ€, ìµœì†Œ
Article.objects.aggregate(
    avg_comments=Avg('comment__id'),
    max_likes=Max('like_users__id'),
    min_pk=Min('pk')
)
```

---

### select_related

#### ì •ì˜

**select_related:**
- SQLì˜ **INNER JOIN**ì„ ì‚¬ìš©í•˜ì—¬ ê´€ë ¨ ê°ì²´ë¥¼ í•¨ê»˜ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œ
- **ForeignKey** ë˜ëŠ” **OneToOneField** ê´€ê³„ì—ì„œ ì‚¬ìš©
- ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ê´€ë ¨ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë¡œë“œí•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ

---

#### select_related ì˜ˆì‹œ

```python
Book.objects.select_related('publisher')
```

**ì˜ë¯¸:**
- Book ëª¨ë¸ê³¼ ì—°ê´€ëœ Publisher ëª¨ë¸ì˜ ë°ì´í„°ë¥¼ í•¨ê»˜ ê°€ì ¸ì˜´
- ForeignKey ê´€ê³„ì¸ 'publisher'ë¥¼ JOINí•˜ì—¬ ë‹¨ì¼ ì¿¼ë¦¬ ë§Œìœ¼ë¡œ ë°ì´í„°ë¥¼ ì¡°íšŒ

**ê²°ê³¼:**
- Book ê°ì²´ë¥¼ ì¡°íšŒí•  ë•Œ ì—°ê´€ëœ Publisher ì •ë³´ë„ í•¨ê»˜ ë¡œë“œ
- `book.publisher.name`ê³¼ ê°™ì€ ì ‘ê·¼ì„ ì¶”ê°€ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì—†ì´ ê°€ëŠ¥

---

#### N+1 Problem ìƒí™© (1/2)

**ë¬¸ì œ ë°œìƒ:**
```
'77 queries including 10 similar and 8 duplicates'
```

**index_2.html í…œí”Œë¦¿:**
```django
{% for article in articles %}
  <h3>ì‘ì„±ì: {{ article.user.username }}</h3>
  <p>ì œëª©: {{ article.title }}</p>
  <hr>
{% endfor %}
```

**ì¿¼ë¦¬ ì‹¤í–‰ ë‚´ì—­:**
```sql
-- 1. ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ
SELECT * FROM "articles_article" ORDER BY "articles_article"."id" DESC

-- 2-77. ê° ê²Œì‹œê¸€ì˜ ì‘ì„±ì ì •ë³´ ì¡°íšŒ (ë°˜ë³µ!)
SELECT * FROM "accounts_user" WHERE "accounts_user"."id" = 5 LIMIT 21
SELECT * FROM "accounts_user" WHERE "accounts_user"."id" = 1 LIMIT 21
SELECT * FROM "accounts_user" WHERE "accounts_user"."id" = 2 LIMIT 21
... (ë°˜ë³µ)
```

---

#### N+1 Problem ì›ì¸ (2/2)

**ë¬¸ì œ ë¶„ì„:**
1. ê²Œì‹œê¸€ì˜ ì‘ì„±ìë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ì¶”ê°€ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ìš”ì²­ë˜ê³  ìˆìŒ
2. ê°™ì€ ì‘ì„±ìê°€ ì‘ì„±í•œ ì—¬ëŸ¬ ê°œì˜ ê²Œì‹œê¸€ë“¤ë„ ê°ê° ì‘ì„±ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•´ ë™ì¼í•˜ê²Œ ì¿¼ë¦¬ë¥¼ ìš”ì²­í•˜ì—¬ **ì¤‘ë³µ ì¿¼ë¦¬ ë°œìƒ**
3. í•´ë‹¹ ìš”ì²­ì„ ë§ì€ ì‚¬ìš©ìê°€ ìš”ì²­í•˜ëŠ” ê²½ìš° ì¤‘ë³µëœ ì¿¼ë¦¬ë¡œ ì¸í•´ **ì„œë²„ì˜ ì„±ëŠ¥ì´ ì €í•˜ë¨**

> **N+1 Problem:** 
> - 1ë²ˆì˜ ê¸°ë³¸ ì¿¼ë¦¬ + Nê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ” ë¬¸ì œ
> - ì„±ëŠ¥ ì €í•˜ì˜ ì£¼ìš” ì›ì¸

---

#### select_related ì ìš© (1/2)

**ë¬¸ì œ í•´ê²°:**
ê²Œì‹œê¸€ì„ ì¡°íšŒí•˜ë©´ì„œ ìœ ì € ì •ë³´ê¹Œì§€ í•œë²ˆì— ì¡°íšŒí•´ì„œ ê°€ì ¸ì˜¤ê¸°

```python
# articles/views.py

def index_2(request):
    # ê¸°ì¡´ ì½”ë“œ (N+1 Problem ë°œìƒ)
    # articles = Article.objects.order_by('-pk')
    
    # ê°œì„ ëœ ì½”ë“œ
    articles = Article.objects.select_related('user').order_by('-pk')
    
    context = {
        'articles': articles,
    }
    return render(request, 'articles/index_2.html', context)
```

---

#### select_related ì ìš© (2/2)

**ê²°ê³¼:**
```
'77 queries including 10 similar and 8 duplicates'
â†“
'1 query'
```

**ì‹¤í–‰ëœ SQL ì¿¼ë¦¬:**
```sql
SELECT 
    "articles_article"."id",
    "articles_article"."user_id",
    "articles_article"."title",
    "articles_article"."content",
    "articles_article"."created_at",
    "articles_article"."updated_at",
    "accounts_user"."id",
    "accounts_user"."password",
    "accounts_user"."last_login",
    "accounts_user"."is_superuser",
    "accounts_user"."username",
    -- ... (userì˜ ëª¨ë“  í•„ë“œ)
FROM "articles_article"
INNER JOIN "accounts_user" 
    ON ("articles_article"."user_id" = "accounts_user"."id")
ORDER BY "articles_article"."id" DESC
```

**ì„±ëŠ¥ ê°œì„ :**
- 77ê°œì˜ ì¿¼ë¦¬ â†’ 1ê°œì˜ ì¿¼ë¦¬
- INNER JOINì„ ì‚¬ìš©í•˜ì—¬ í•œ ë²ˆì— ëª¨ë“  ë°ì´í„° ì¡°íšŒ

---

### prefetch_related

#### ì •ì˜

**prefetch_related:**
- SQLì´ ì•„ë‹Œ **Pythonì„ ì‚¬ìš©í•œ JOIN**ì„ ì§„í–‰
- ê´€ë ¨ ê°ì²´ë“¤ì„ ë¯¸ë¦¬ ê°€ì ¸ì™€ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ì—¬ ì„±ëŠ¥ì„ í–¥ìƒ
- **M:N** ë˜ëŠ” **N:1 ì—­ì°¸ì¡°** ê´€ê³„ì—ì„œ ì‚¬ìš©
- ManyToManyFieldë‚˜ ì—­ì°¸ì¡° ê´€ê³„ì— ëŒ€í•´ ë³„ë„ì˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰

---

#### prefetch_related ì˜ˆì‹œ

```python
Book.objects.prefetch_related('authors')
```

**ì˜ë¯¸:**
- Bookê³¼ AuthorëŠ” ManyToMany ê´€ê³„ë¡œ ê°€ì •
- Book ëª¨ë¸ê³¼ ì—°ê´€ëœ ëª¨ë“  Author ëª¨ë¸ì˜ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ê°€ì ¸ì˜´
- Djangoê°€ ë³„ë„ì˜ ì¿¼ë¦¬ë¡œ Author ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ê´€ê³„ë¥¼ ì„¤ì •

**ê²°ê³¼:**
- Book ê°ì²´ë“¤ì„ ì¡°íšŒí•œ í›„ ì—°ê´€ëœ ëª¨ë“  Author ì •ë³´ê°€ ë¯¸ë¦¬ ë¡œë“œë¨
- `for author in book.authors.all()`ì™€ ê°™ì€ ë°˜ë³µì´ ì¶”ê°€ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì—†ì´ ì‹¤í–‰ë¨

---

#### N+1 Problem ìƒí™© (prefetch_related)

**ë¬¸ì œ ë°œìƒ:**
```
'11 queries including 10 similar'
```

**index_3.html í…œí”Œë¦¿:**
```django
{% for article in articles %}
  <p>ì œëª©: {{ article.title }}</p>
  <p>ëŒ“ê¸€ ëª©ë¡</p>
  {% for comment in article.comment_set.all %}
    <p>{{ comment.content }}</p>
  {% endfor %}
  <hr>
{% endfor %}
```

**ì¿¼ë¦¬ ì‹¤í–‰ ë‚´ì—­:**
```sql
-- 1. ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ
SELECT * FROM "articles_article" ORDER BY "articles_article"."id" DESC

-- 2-11. ê° ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ì¡°íšŒ (10ë²ˆ ë°˜ë³µ!)
SELECT * FROM "articles_comment" WHERE "articles_comment"."article_id" = 10
SELECT * FROM "articles_comment" WHERE "articles_comment"."article_id" = 9
SELECT * FROM "articles_comment" WHERE "articles_comment"."article_id" = 8
... (ë°˜ë³µ)
```

---

#### prefetch_related ì ìš©

```python
# articles/views.py

def index_3(request):
    # ê¸°ì¡´ ì½”ë“œ (N+1 Problem ë°œìƒ)
    # articles = Article.objects.order_by('-pk')
    
    # ê°œì„ ëœ ì½”ë“œ
    articles = Article.objects.prefetch_related('comment_set').order_by('-pk')
    
    context = {
        'articles': articles,
    }
    return render(request, 'articles/index_3.html', context)
```

**ê²°ê³¼:**
```
'11 queries including 10 similar'
â†“
'2 queries'
```

**ì‹¤í–‰ëœ SQL ì¿¼ë¦¬:**
```sql
-- 1. ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ
SELECT * FROM "articles_article" ORDER BY "articles_article"."id" DESC

-- 2. ëª¨ë“  ëŒ“ê¸€ì„ í•œë²ˆì— ì¡°íšŒ
SELECT * FROM "articles_comment" 
WHERE "articles_comment"."article_id" IN (1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
```

**ì„±ëŠ¥ ê°œì„ :**
- 11ê°œì˜ ì¿¼ë¦¬ â†’ 2ê°œì˜ ì¿¼ë¦¬
- IN ì—°ì‚°ìë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ë ¨ëœ ëª¨ë“  ëŒ“ê¸€ì„ í•œ ë²ˆì— ì¡°íšŒ

---

### select_related & prefetch_related

#### í•¨ê»˜ ì‚¬ìš©í•˜ê¸°

**ë³µí•©ì ì¸ ê´€ê³„ ìµœì í™”:**

```python
# articles/views.py

def index_4(request):
    # ê²Œì‹œê¸€ + ì‘ì„±ì(FK) + ëŒ“ê¸€(ì—­ì°¸ì¡°) + ëŒ“ê¸€ ì‘ì„±ì(FK)
    articles = Article.objects.select_related('user') \
                              .prefetch_related(
                                  Prefetch('comment_set', 
                                          queryset=Comment.objects.select_related('user'))
                              ) \
                              .order_by('-pk')
    
    context = {
        'articles': articles,
    }
    return render(request, 'articles/index_4.html', context)
```

**í…œí”Œë¦¿:**
```django
{% for article in articles %}
  <h3>ì‘ì„±ì: {{ article.user.username }}</h3>
  <p>ì œëª©: {{ article.title }}</p>
  
  <p>ëŒ“ê¸€ ëª©ë¡</p>
  {% for comment in article.comment_set.all %}
    <p>{{ comment.user.username }}: {{ comment.content }}</p>
  {% endfor %}
  <hr>
{% endfor %}
```

**ì„±ëŠ¥:**
- ìµœì í™” ì „: 100+ ì¿¼ë¦¬
- ìµœì í™” í›„: 3ê°œ ì¿¼ë¦¬
  1. Article + User (INNER JOIN)
  2. Comment (IN)
  3. Commentì˜ User (INNER JOIN)

---

### select_related vs prefetch_related

| êµ¬ë¶„ | select_related | prefetch_related |
|------|----------------|------------------|
| **ì‚¬ìš© ê´€ê³„** | ForeignKey, OneToOneField | ManyToManyField, ì—­ì°¸ì¡° |
| **JOIN ë°©ì‹** | SQL INNER JOIN | Pythonì—ì„œ JOIN |
| **ì¿¼ë¦¬ ìˆ˜** | 1ê°œ (JOIN) | 2ê°œ ì´ìƒ (IN ì—°ì‚°ì) |
| **ì‚¬ìš© ì˜ˆì‹œ** | `Article â†’ User` | `Article â†’ Comments` |
| **ë©”ì„œë“œ ì²´ì´ë‹** | ê°€ëŠ¥ | ê°€ëŠ¥ |

---

### exists() method

#### ì •ì˜

**exists():**
- ì¿¼ë¦¬ì…‹ì— ê²°ê³¼ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ True, ì—†ìœ¼ë©´ False ë°˜í™˜

---

#### ì‚¬ìš© ì˜ˆì‹œ

```python
# ë‚˜ìœ ì˜ˆ - ì „ì²´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ í™•ì¸
if article.like_users.all():
    # ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ í™•ì¸
    pass

# ì¢‹ì€ ì˜ˆ - ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸
if article.like_users.exists():
    # ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸ (í›¨ì”¬ ë¹ ë¦„)
    pass
```

```python
# íŒ”ë¡œìš° ì—¬ë¶€ í™•ì¸ (ë‚˜ìœ ì˜ˆ)
if request.user in person.followers.all():
    person.followers.remove(request.user)

# íŒ”ë¡œìš° ì—¬ë¶€ í™•ì¸ (ì¢‹ì€ ì˜ˆ)
if person.followers.filter(pk=request.user.pk).exists():
    person.followers.remove(request.user)
```

**ì¥ì :**
- ì „ì²´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ì•Šê³  ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸
- ëŒ€ê·œëª¨ ì¿¼ë¦¬ì…‹ì—ì„œ íš¨ìœ¨ì 

---

### í•œêº¼ë²ˆì— dump í•˜ê¸°

#### ì—¬ëŸ¬ ì•±ì˜ ë°ì´í„°ë¥¼ í•œë²ˆì— ë°±ì—…

```bash
# ë°©ë²• 1: ì „ì²´ ë°ì´í„° ë°±ì—…
$ python manage.py dumpdata --indent 4 > all_data.json

# ë°©ë²• 2: íŠ¹ì • ì•±ë“¤ë§Œ ë°±ì—…
$ python manage.py dumpdata --indent 4 articles accounts > data.json

# ë°©ë²• 3: ì—¬ëŸ¬ íŒŒì¼ë¡œ ë¶„ë¦¬ ë°±ì—… (ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±)
$ python manage.py dumpdata --indent 4 articles.article > articles.json
$ python manage.py dumpdata --indent 4 articles.comment > comments.json
$ python manage.py dumpdata --indent 4 accounts.user > users.json
```

---

### loaddata ì¸ì½”ë”© ì—ëŸ¬

#### ë¬¸ì œ ìƒí™©

```bash
$ python manage.py loaddata articles.json
```

**ì—ëŸ¬ ë©”ì‹œì§€:**
```
UnicodeDecodeError: 'cp949' codec can't decode byte ...
```

---

#### í•´ê²° ë°©ë²• 1: dumpdata ì‹œ UTF-8 ì§€ì •

```bash
$ python -Xutf8 manage.py dumpdata articles.article > articles.json
```

---

#### í•´ê²° ë°©ë²• 2: ë©”ëª¨ì¥ì—ì„œ ì¸ì½”ë”© ë³€ê²½

1. ë©”ëª¨ì¥ì—ì„œ JSON íŒŒì¼ ì—´ê¸°
2. `ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥` í´ë¦­
3. ì¸ì½”ë”©ì„ `UTF-8`ë¡œ ì„ íƒ
4. ì €ì¥

**ë©”ëª¨ì¥ ì¸ì½”ë”© ì„ íƒ í™”ë©´:**
```
íŒŒì¼ ì´ë¦„: articles.json
íŒŒì¼ í˜•ì‹: í…ìŠ¤íŠ¸ ë¬¸ì„œ (*.txt)
ì¸ì½”ë”©: [ANSI â–¼]  â†’  [UTF-8] ì„ íƒ
       ANSI
       UTF-16 LE
       UTF-8  â† ì„ íƒ
```

---

#### í•´ê²° ë°©ë²• 3: VSCodeì—ì„œ ì¸ì½”ë”© ë³€ê²½

1. VSCodeì—ì„œ JSON íŒŒì¼ ì—´ê¸°
2. ìš°ì¸¡ í•˜ë‹¨ì˜ ì¸ì½”ë”© í‘œì‹œ í´ë¦­ (ì˜ˆ: `ANSI`)
3. `Reopen with Encoding` ì„ íƒ
4. `UTF-8` ì„ íƒ
5. íŒŒì¼ ì €ì¥

**VSCode í•˜ë‹¨ ë°”:**
```
Ln 1, Col 1    Spaces: 4    UTF-8    CRLF    JSON
                             â†‘ ì—¬ê¸° í´ë¦­
```

---

## ğŸ”‘ í•µì‹¬ í‚¤ì›Œë“œ ì •ë¦¬

| ê°œë… | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| **self ê´€ê³„** | ëª¨ë¸ì´ ìê¸° ìì‹ ì„ ì°¸ì¡°í•˜ëŠ” ê´€ê³„ | ìœ ì € â†” ìœ ì € (íŒ”ë¡œìš°) |
| **symmetrical** | ê´€ê³„ì˜ ëŒ€ì¹­ ì—¬ë¶€ë¥¼ ì„¤ì •í•˜ëŠ” ì†ì„± | ì¹œêµ¬ ê´€ê³„: True, íŒ”ë¡œìš° ê´€ê³„: False |
| **fixtures** | JSONì´ë‚˜ YAML íŒŒì¼ë¡œ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•˜ëŠ” Django ê¸°ëŠ¥ | `python manage.py dumpdata` |
| **annotate** | ì§‘ê³„ í•¨ìˆ˜ ê²°ê³¼ë¥¼ QuerySetì— ì£¼ì„ì²˜ëŸ¼ ì¶”ê°€ | ëŒ“ê¸€ ê°œìˆ˜, ì¢‹ì•„ìš” ìˆ˜ í‘œì‹œ |
| **select_related** | ForeignKey ê´€ê³„ì˜ ê°ì²´ë¥¼ ë¯¸ë¦¬ ë¡œë“œí•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ | `select_related('author')` |
| **prefetch_related** | ManyToMany ë˜ëŠ” reverse ê´€ê³„ë¥¼ ë¯¸ë¦¬ ë¡œë”© | `prefetch_related('comments')` |
| **exists** | QuerySetì— í•´ë‹¹ ê°ì²´ê°€ ì¡´ì¬í•˜ëŠ”ì§€ë¥¼ Booleanìœ¼ë¡œ ë°˜í™˜ | `Comment.objects.filter().exists()` |
| **N+1 Problem** | 1ë²ˆì˜ ê¸°ë³¸ ì¿¼ë¦¬ + Nê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ” ë¬¸ì œ | ê²Œì‹œê¸€ ì¡°íšŒ í›„ ê° ì‘ì„±ìë¥¼ ê°œë³„ ì¡°íšŒ |

---

## ğŸ“ ìš”ì•½ ë° ì •ë¦¬

### íŒ”ë¡œìš° ê´€ê³„ êµ¬í˜„í•˜ê¸°
- ìœ ì € â†” ìœ ì € êµ¬ì¡°ë¥¼ self ê´€ê³„ë¡œ ì •ì˜í•˜ê³  symmetrical ì†ì„±ì„ Falseë¡œ ì„¤ì •
- í”„ë¡œí•„ì—ì„œ íŒ”ë¡œìš° ì—¬ë¶€, ê²Œì‹œê¸€, ëŒ“ê¸€ ì •ë³´ ë“±ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì¡°íšŒ ê°€ëŠ¥

### fixturesë¡œ ë¹ ë¥¸ ë°ì´í„° ì…ì¶œë ¥ í•˜ê¸°
- dumpdataì™€ loaddataë¥¼ í†µí•´ ë°±ì—…ê³¼ ë³µì› ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ
- í…ŒìŠ¤íŠ¸ ë°ì´í„°ë‚˜ ì´ˆê¸° ì„¤ì • ë°ì´í„° ê´€ë¦¬ê°€ ì‰¬ì›Œì§

### ì¿¼ë¦¬ ìµœì í™”ì˜ í•µì‹¬
- **annotate**: ì§‘ê³„ í•¨ìˆ˜ë¡œ ê³„ì‚°ëœ í•„ë“œ ì¶”ê°€
- **select_related**: FK ê´€ê³„ë¥¼ SQL JOINìœ¼ë¡œ ìµœì í™”
- **prefetch_related**: N:M/ì—­ì°¸ì¡° ê´€ê³„ë¥¼ ë³„ë„ ì¿¼ë¦¬ë¡œ ìµœì í™”
- **exists**: ë¹ ë¥´ê²Œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸

### N+1 Problem í•´ê²° ì „ëµ
1. ë¬¸ì œ ì¸ì‹: Django Debug Toolbarë¡œ ì¿¼ë¦¬ ìˆ˜ í™•ì¸
2. ê´€ê³„ íŒŒì•…: FKì¸ì§€ M:N/ì—­ì°¸ì¡°ì¸ì§€ í™•ì¸
3. ì ì ˆí•œ ë©”ì„œë“œ ì„ íƒ:
   - FK â†’ select_related
   - M:N/ì—­ì°¸ì¡° â†’ prefetch_related
   - ë³µí•© ê´€ê³„ â†’ ë‘˜ ë‹¤ ì‚¬ìš©

---

## ğŸ“ í•™ìŠµ ë§ˆë¬´ë¦¬

Djangoì—ì„œ ìœ ì € ê´€ê³„ë¥¼ ì •ì˜í•˜ê³  ì¿¼ë¦¬ ì„±ëŠ¥ì„ ë†’ì´ëŠ” ë°©ë²•ì„ í•™ìŠµí–ˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ì •ë¦¬:**

1. ìœ ì € ê°„ íŒ”ë¡œìš° ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë ¤ë©´ **ìê¸° ìì‹ ì„ ì°¸ì¡°í•˜ëŠ” ê´€ê³„(self ê´€ê³„)**ë¥¼ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤

2. ë‹¤ëŒ€ë‹¤ ê´€ê³„ êµ¬ì„± ì‹œ ì—­ì°¸ì¡°ëª… ì¶©ëŒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ **related_name**ì„ ì„¤ì •í•©ë‹ˆë‹¤

3. **fixtures(dumpdata/loaddata)**ë¥¼ í™œìš©í•˜ë©´ íŒ”ë¡œìš° í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì†ì‰½ê²Œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

4. **N+1 ë¬¸ì œ**ë¥¼ í•´ê²°í•˜ë ¤ë©´ annotate, select_related, prefetch_relatedì˜ ì‚¬ìš© ë°©ì‹ì— ìµìˆ™í•´ì ¸ì•¼ í•©ë‹ˆë‹¤

5. **exists ë©”ì„œë“œ**ë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¹ì • ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ íŒë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

ì´ëŸ¬í•œ ê¸°ìˆ ë“¤ì€ íŒ”ë¡œìš° ê¸°ëŠ¥ë¿ë§Œ ì•„ë‹ˆë¼ ìœ ì € ê¸°ë°˜ ìƒí˜¸ì‘ìš© ê¸°ëŠ¥ì—ë„ í™•ì¥ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•™ìŠµí•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‹¤ë¬´ í”„ë¡œì íŠ¸ì—ì„œ ê´€ê³„ ì •ì˜ì™€ ì„±ëŠ¥ ê°œì„ ì„ ë™ì‹œì— ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ§ª ì‹¤ì „ ì—°ìŠµ ë¬¸ì œ

### 1. N+1 Problem ì¸ì‹í•˜ê¸°

ë‹¤ìŒ ì½”ë“œì—ì„œ N+1 Problemì´ ë°œìƒí•˜ëŠ” ë¶€ë¶„ì„ ì°¾ê³  í•´ê²°í•˜ì„¸ìš”:

```python
# views.py
def index(request):
    articles = Article.objects.all()
    return render(request, 'articles/index.html', {'articles': articles})
```

```django
<!-- index.html -->
{% for article in articles %}
  <h3>{{ article.user.username }}</h3>
  <p>{{ article.title }}</p>
  <p>ëŒ“ê¸€ ìˆ˜: {{ article.comment_set.count }}</p>
  <p>ì¢‹ì•„ìš” ìˆ˜: {{ article.like_users.count }}</p>
{% endfor %}
```

**í•´ê²°:**
```python
from django.db.models import Count

def index(request):
    articles = Article.objects.select_related('user') \
                              .prefetch_related('comment_set', 'like_users') \
                              .annotate(
                                  comment_count=Count('comment'),
                                  like_count=Count('like_users')
                              ) \
                              .all()
    return render(request, 'articles/index.html', {'articles': articles})
```

---

### 2. annotateë¡œ ì§‘ê³„í•˜ê¸°

ê° ìœ ì €ì˜ ì‘ì„± ê²Œì‹œê¸€ ìˆ˜, ì‘ì„± ëŒ“ê¸€ ìˆ˜, íŒ”ë¡œì›Œ ìˆ˜, íŒ”ë¡œì‰ ìˆ˜ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”:

```python
from django.db.models import Count

users = User.objects.annotate(
    article_count=Count('article'),
    comment_count=Count('comment'),
    followers_count=Count('followers'),
    followings_count=Count('followings')
)

for user in users:
    print(f'{user.username}: ê²Œì‹œê¸€ {user.article_count}, ëŒ“ê¸€ {user.comment_count}, íŒ”ë¡œì›Œ {user.followers_count}, íŒ”ë¡œì‰ {user.followings_count}')
```

---

### 3. í”„ë¡œí•„ í˜ì´ì§€ ìµœì í™”

í”„ë¡œí•„ í˜ì´ì§€ì—ì„œ ë°œìƒí•˜ëŠ” ì¿¼ë¦¬ë¥¼ ìµœì†Œí™”í•˜ì„¸ìš”:

```python
def profile(request, username):
    User = get_user_model()
    
    # ìµœì í™” ì „
    # person = User.objects.get(username=username)
    
    # ìµœì í™” í›„
    person = User.objects.prefetch_related(
        'article_set',
        'comment_set', 
        'like_articles',
        'followers',
        'followings'
    ).annotate(
        article_count=Count('article'),
        comment_count=Count('comment'),
        followers_count=Count('followers'),
        followings_count=Count('followings')
    ).get(username=username)
    
    context = {
        'person': person,
    }
    return render(request, 'accounts/profile.html', context)
```

---

## ğŸ“Š ì¿¼ë¦¬ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸

| ìƒí™© | í•´ê²° ë°©ë²• | ì˜ˆì‹œ |
|------|-----------|------|
| **ForeignKey ì ‘ê·¼** | `select_related()` | `Article.objects.select_related('user')` |
| **ManyToManyField ì ‘ê·¼** | `prefetch_related()` | `Article.objects.prefetch_related('like_users')` |
| **ì—­ì°¸ì¡° ì ‘ê·¼** | `prefetch_related()` | `User.objects.prefetch_related('article_set')` |
| **ì§‘ê³„ ê°’ í•„ìš”** | `annotate()` | `Article.objects.annotate(comment_count=Count('comment'))` |
| **ì¡´ì¬ ì—¬ë¶€ í™•ì¸** | `exists()` | `article.like_users.filter(pk=user.pk).exists()` |
| **ê°œìˆ˜ë§Œ í•„ìš”** | `count()` | `article.comment_set.count()` |
| **ë³µí•© ê´€ê³„** | ì—¬ëŸ¬ ë©”ì„œë“œ ì²´ì´ë‹ | `select_related().prefetch_related().annotate()` |
