# 데이터링크 계층

## 들어가기 전에 알아야 할 내용

### 네트워크 계층 복습
- **물리 계층**: 비트를 전기 신호로 변환하여 전송
- **데이터링크 계층**: 물리 계층 바로 위, 같은 네트워크 내에서 노드 간 데이터 전송 담당
- **네트워크 계층**: 서로 다른 네트워크 간 경로를 찾아 데이터 전송

### 데이터링크 계층의 필요성
물리 계층은 단순히 비트만 전송함. 하지만 현실에서는 다음과 같은 문제 발생
- 전송 중 오류 발생 가능
- 누구에게 보내는지 구분 필요
- 데이터의 시작과 끝 구분 필요
- 전송 속도 조절 필요

→ 이러한 문제를 해결하는 것이 데이터링크 계층

---

## 1. 데이터링크 계층의 역할

### 핵심 기능

#### (1) 프레이밍 (Framing)
비트 스트림을 의미 있는 단위(프레임)로 나누는 작업

```
물리 계층의 비트 스트림:
01010101110010101010...

데이터링크 계층의 프레임:
┌────────┬─────────┬──────┬─────┐
│ 헤더   │ 데이터   │ 트레일러│
└────────┴─────────┴──────┴─────┘
프레임 1             프레임 2
```

#### (2) 주소 지정
같은 네트워크 내에서 목적지 노드 식별

- **MAC 주소 (Media Access Control Address)** 사용
- 48비트 물리적 주소
- 네트워크 카드(NIC)에 고유하게 부여됨

#### (3) 오류 제어
전송 중 발생한 오류 검출 및 정정

- 비트 오류 검출
- 손상된 프레임 재전송 요청

#### (4) 흐름 제어
송신자와 수신자의 데이터 처리 속도 차이 조절

- 수신자가 처리할 수 있는 속도로 전송
- 버퍼 오버플로우 방지

#### (5) 접근 제어
여러 노드가 같은 통신 매체를 공유할 때 충돌 방지

- 누가 언제 전송할지 결정
- 매체 접근 조정

---

## 2. 프레임 구조

### 일반적인 프레임 형식

```
┌──────────┬───────────┬──────────┬─────────┬─────────┬──────────┐
│시작 플래그│목적지 주소│출발지 주소│  제어   │ 데이터  │   FCS    │
└──────────┴───────────┴──────────┴─────────┴─────────┴──────────┘
   1바이트     6바이트      6바이트   2바이트  가변     4바이트
```

### 각 필드의 역할

#### 시작 플래그 (Start Flag)
- 프레임의 시작을 알림
- 수신자가 프레임의 경계 인식

#### 목적지 주소 (Destination Address)
- 수신할 노드의 MAC 주소
- 6바이트 (48비트)

#### 출발지 주소 (Source Address)
- 송신한 노드의 MAC 주소
- 6바이트 (48비트)

#### 제어 (Control)
- 프레임 타입 정보
- 순서 번호 등

#### 데이터 (Data)
- 실제 전송할 데이터
- 상위 계층(네트워크 계층)에서 내려온 패킷
- 보통 46~1500바이트

#### FCS (Frame Check Sequence)
- 오류 검출을 위한 체크섬
- CRC (Cyclic Redundancy Check) 사용
- 4바이트

---

## 3. MAC 주소

### MAC 주소란?
**네트워크 장비의 물리적 주소, 전 세계에서 유일한 값**

### MAC 주소 구조

```
48비트 = 6바이트 = 12개의 16진수

예시: 00:1A:2B:3C:4D:5E

┌────────────────┬────────────────┐
│ OUI (24비트)   │ 고유번호(24비트)│
└────────────────┴────────────────┘
  제조사 식별자      제조사가 부여
```

### MAC 주소 표기법

```
콜론(:) 구분: 00:1A:2B:3C:4D:5E
하이픈(-) 구분: 00-1A-2B-3C-4D-5E
점(.) 구분: 001A.2B3C.4D5E
```

### 특수 MAC 주소

#### 브로드캐스트 주소
```
FF:FF:FF:FF:FF:FF

의미: 같은 네트워크의 모든 노드에게 전송
사용: ARP 요청, DHCP 요청 등
```

#### 멀티캐스트 주소
```
첫 바이트 최하위 비트가 1

예시: 01:00:5E:XX:XX:XX

의미: 특정 그룹의 노드들에게 전송
```

---

## 4. 오류 제어

### (1) 오류 검출

#### 패리티 비트 (Parity Bit)
가장 간단한 오류 검출 방법

```
짝수 패리티:
데이터: 1011001
1의 개수: 4개 (짝수)
패리티 비트: 0

데이터: 1011011
1의 개수: 5개 (홀수)
패리티 비트: 1
```

**한계**: 2개 이상 오류 시 검출 불가

#### 체크섬 (Checksum)
모든 데이터를 더해서 합계를 계산

```
동작:
1. 송신: 모든 바이트 더해서 체크섬 계산
2. 수신: 받은 데이터로 체크섬 재계산
3. 비교: 두 체크섬이 같으면 오류 없음
```

#### CRC (Cyclic Redundancy Check)
데이터링크 계층에서 가장 많이 사용하는 오류 검출 방법

```
원리:
1. 데이터를 다항식으로 표현
2. 생성 다항식으로 나눔
3. 나머지를 FCS로 사용

특징:
- 강력한 오류 검출 능력
- 연속된 비트 오류 검출 가능
- 하드웨어로 구현 효율적
```

### (2) 오류 정정

#### 자동 재전송 요청 (ARQ)

**Stop-and-Wait ARQ**
```
송신자: [프레임1 전송] ─────→
수신자:                    [ACK 수신]

송신자: [프레임2 전송] ─────→
                     오류 발생!
수신자:                    [NAK 전송]

송신자: [프레임2 재전송] ───→
수신자:                    [ACK 수신]
```

**특징**:
- 프레임 하나씩 전송 후 응답 대기
- 단순하지만 비효율적

**Go-Back-N ARQ**
```
연속으로 N개 프레임 전송 가능
오류 발생 시 해당 프레임부터 모두 재전송
```

**Selective Repeat ARQ**
```
오류 발생한 프레임만 선택적으로 재전송
효율적이지만 구현 복잡
```

---

## 5. 흐름 제어

### 필요성
```
문제 상황:
- 송신자: 1Gbps 속도로 전송
- 수신자: 100Mbps 속도로 처리

결과:
- 수신자 버퍼 오버플로우
- 데이터 손실
```

### (1) Stop-and-Wait 방식

```
송신자: [프레임 전송]
        ↓
        [ACK 대기]
        ↓
수신자: [ACK 전송]
        ↓
송신자: [다음 프레임 전송]
```

**장점**: 구현 단순
**단점**: 전송 효율 낮음 (대기 시간 김)

### (2) 슬라이딩 윈도우 (Sliding Window)

#### 개념
ACK 받기 전에 여러 프레임을 연속으로 전송 가능

```
윈도우 크기 = 4

송신자 버퍼:
┌───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │
└───┴───┴───┴───┴───┴───┴───┘
  └───────윈도우────┘
  이 범위 내 프레임 전송 가능
```

#### 동작 과정

```
1. 프레임 0,1,2,3 전송 (윈도우 크기 4)
2. 프레임 0에 대한 ACK 수신
3. 윈도우 오른쪽으로 이동
   ┌───┬───┬───┬───┐
   │ 1 │ 2 │ 3 │ 4 │
   └───┴───┴───┴───┘
4. 프레임 4 전송 가능
```

**장점**:
- 전송 효율 높음
- 네트워크 대역폭 활용 극대화

**단점**:
- 구현 복잡
- 버퍼 관리 필요

---

## 6. 매체 접근 제어 (MAC)

### 필요성
```
문제:
- 여러 노드가 하나의 통신 매체 공유
- 동시에 전송하면 충돌 발생
- 데이터 손상

해결:
- 누가 언제 전송할지 조정
```

### (1) 랜덤 접근 방식

#### CSMA/CD (Carrier Sense Multiple Access with Collision Detection)

**유선 이더넷에서 사용**

```
동작 과정:

1. 캐리어 감지 (Carrier Sense)
   - 전송 전 매체가 사용 중인지 확인
   - 사용 중이면 대기

2. 다중 접근 (Multiple Access)
   - 매체가 비어있으면 전송 시작

3. 충돌 검출 (Collision Detection)
   - 전송 중 충돌 감지
   - 충돌 감지 시 즉시 전송 중단

4. 재시도
   - 랜덤 시간 대기 후 재전송
```

#### CSMA/CA (Carrier Sense Multiple Access with Collision Avoidance)

**무선 LAN(Wi-Fi)에서 사용**

```
차이점:
- 무선에서는 충돌 검출 어려움
- 충돌 회피에 집중

동작:
1. 매체 감지
2. 비어있으면 짧은 시간 대기 (DIFS)
3. 여전히 비어있으면 전송
4. ACK 대기
```

### (2) 제어 접근 방식

#### 토큰 패싱 (Token Passing)
```
특수한 프레임(토큰)을 순환시킴
토큰을 가진 노드만 전송 가능

┌───┐    ┌───┐
│ A │───→│ B │
└───┘    └───┘
  ↑        ↓
┌───┐    ┌───┐
│ D │←───│ C │
└───┘    └───┘

순서: A → B → C → D → A → ...
```

**장점**:
- 충돌 없음
- 예측 가능한 지연 시간

**단점**:
- 토큰 유지 관리 오버헤드
- 노드 장애 시 문제

---

## 7. 이더넷 (Ethernet)

### 이더넷이란?
**가장 널리 사용되는 유선 LAN 기술**

### 이더넷 프레임 구조

```
┌─────────┬─────────┬─────────┬──────┬─────┬─────┐
│프리앰블 │목적지MAC│출발지MAC│ 타입 │데이터│ FCS │
└─────────┴─────────┴─────────┴──────┴─────┴─────┘
 7바이트    6바이트   6바이트  2바이트 가변  4바이트
```

### 필드 설명

#### 프리앰블 (Preamble)
```
7바이트: 10101010... 반복
동기화 신호
```

#### SFD (Start Frame Delimiter)
```
1바이트: 10101011
프레임 시작 표시
```

#### 타입 (Type/Length)
```
상위 계층 프로토콜 식별
0x0800: IPv4
0x0806: ARP
0x86DD: IPv6
```

#### 데이터
```
최소: 46바이트
최대: 1500바이트
부족하면 패딩 추가
```

### 이더넷 발전

```
10BASE-T    → 10 Mbps
100BASE-TX  → 100 Mbps (Fast Ethernet)
1000BASE-T  → 1 Gbps (Gigabit Ethernet)
10GBASE-T   → 10 Gbps
```

---

## 8. 스위치 (Switch)

### 스위치 동작 원리

#### (1) MAC 주소 학습

```
초기 상태:
스위치의 MAC 주소 테이블: 비어있음

포트1에서 프레임 수신 (출발지 MAC: A)
→ 테이블에 기록: 포트1 - MAC A

포트2에서 프레임 수신 (출발지 MAC: B)
→ 테이블에 기록: 포트2 - MAC B
```

#### (2) 프레임 전달

```
목적지 MAC 주소 확인
  ↓
MAC 테이블 검색
  ↓
  ├─ 해당 포트로만 전달 (유니캐스트)
  ├─ 모든 포트로 전달 (브로드캐스트)
  └─ 플러딩 (테이블에 없는 경우)
```

### 허브 vs 스위치

```
허브 (Hub):
- 모든 포트로 전달
- 충돌 도메인 공유
- 반이중 통신

스위치 (Switch):
- 목적지 포트로만 전달
- 충돌 도메인 분리
- 전이중 통신 가능
- MAC 주소 테이블 유지
```

---

## 9. VLAN (Virtual LAN)

### 개념
**물리적으로 같은 스위치에 연결되어 있지만 논리적으로 분리된 네트워크**

### 필요성

```
문제:
- 브로드캐스트가 모든 포트로 전달됨
- 보안 문제
- 네트워크 혼잡

해결:
- 논리적으로 네트워크 분리
- 브로드캐스트 도메인 분리
```

### VLAN 구성 예시

```
스위치
┌────────────────────────┐
│ 포트1,2,3: VLAN 10     │ 영업부
│ 포트4,5,6: VLAN 20     │ 개발부
└────────────────────────┘

VLAN 10 내부에서만 통신 가능
VLAN 20 내부에서만 통신 가능
VLAN 간 통신은 라우터 필요
```

---

## 10. 핵심 정리

### 데이터링크 계층의 역할
```
1. 프레이밍: 데이터를 프레임으로 구성
2. 주소 지정: MAC 주소로 목적지 식별
3. 오류 제어: CRC로 오류 검출, ARQ로 재전송
4. 흐름 제어: 슬라이딩 윈도우로 속도 조절
5. 접근 제어: CSMA/CD로 충돌 방지
```

### 주요 개념

**MAC 주소**
- 48비트 물리적 주소
- NIC에 고유하게 부여
- 같은 네트워크 내 통신에 사용

**프레임**
- 데이터링크 계층의 데이터 단위
- 헤더 + 데이터 + 트레일러
- 최소 64바이트, 최대 1518바이트 (이더넷)

**오류 제어**
- CRC: 오류 검출
- ARQ: 재전송으로 오류 복구

**매체 접근 제어**
- CSMA/CD: 유선 이더넷
- CSMA/CA: 무선 LAN

**스위치**
- MAC 주소 학습
- 목적지 포트로만 전달
- 충돌 도메인 분리

### 계층 간 관계

```
상위 계층 (네트워크 계층)
         ↓ 패킷
데이터링크 계층
         ↓ 프레임
물리 계층
         ↓ 비트
```